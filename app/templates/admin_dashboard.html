{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<main class="content">
  <h2>Admin Panel - User Management</h2>

  <!-- Admin Summary Cards -->
  <div class="dashboard-grid">
    <div class="card stat">
      <h3>Total Users</h3>
      <p>{{ users|length }}</p>
    </div>
    <div class="card stat">
      <h3>Total Scans</h3>
      <p>{{ total_scans }}</p>
    </div>
  </div>

  <div style="margin: 20px 0;">
    <a href="{{ url_for('main.register') }}" class="button">➕ Add New User</a>
  </div>

  <hr>

  <!-- User Management Table -->
  <h3>Manage Users</h3>
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.username }}</td>
        <td>{{ user.email or "N/A" }}</td>
        <td>{{ user.role or "user" }}</td>
        <td>
          <form method="POST" action="{{ url_for('main.delete_user', user_id=user.id) }}" onsubmit="return confirm('Are you sure you want to delete this user?');" style="display:inline;">
            <button type="submit" style="background-color:#dc2626;">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <hr>

  <!-- User-wise Scan Display -->
  <h3>Triggered Scans by Users</h3>
  {% for username, scans in user_scans.items() %}
    <details style="margin-bottom: 10px;">
      <summary><strong>{{ username }}</strong> ({{ scans | length }} scans)</summary>
      <ul style="margin-top: 8px; padding-left: 20px;">
        {% for scan in scans %}
          <li>
            <a href="{{ url_for('main.scan', scan_id=scan.id) }}" class="view-link">{{ scan.scan_name }}</a>
            — {{ scan.status }} ({{ scan.created_at.strftime('%Y-%m-%d %H:%M') }})
          </li>
        {% endfor %}
      </ul>
    </details>
  {% else %}
    <p>No user scans available.</p>
  {% endfor %}

  <hr>

  <!-- Optional: Admin Logs -->
  <h3>Admin Actions Log</h3>
  <p style="font-size: 0.9em; color: #94a3b8;">(Coming soon — audit log of all critical actions taken by admins.)</p>

</main>
{% endblock %}
